<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
<!ENTITY % BOOK_ENTITIES SYSTEM "Installation_Guide.ent">
%BOOK_ENTITIES;
]>

<chapter id="chap-basic-system-recovery">
	<title>Basic System Recovery</title>


	<indexterm>
		<primary>system recovery</primary>
	</indexterm>


	<para>
		When things go wrong, there are ways to fix problems. However, these methods require that you understand the system well. This chapter contains information on common problems you might face and it also describes <firstterm>installation program rescue mode</firstterm>, which can be used to fix these problems.
	</para>
	<section id="sect-rescue-mode-common-problems">
		<title>Common Problems</title>


		<indexterm>
			<primary>system recovery</primary>
			<secondary>common problems</secondary>
		</indexterm>


		<para>
			You might need to boot into installation program rescue mode for any of the following reasons:
		</para>
		<itemizedlist>
			<listitem>
				<para>
					You are unable to boot into &PRODUCT; normally.
				</para>
			</listitem>
			<listitem>
				<para>
					You are having hardware or software problems, and you want to recover data from your system's hard drive.
				</para>
			</listitem>
			<listitem>
				<para>
					You forgot the root password.
				</para>
			</listitem>
		</itemizedlist>

		<section id="sect-rescue-mode-no-boot">
			<title>Unable to Boot into &PRODUCT;</title>


			<indexterm>
				<primary>system recovery</primary>
				<secondary>common problems</secondary>
				<tertiary>unable to boot into &PRODUCT;</tertiary>
			</indexterm>
			<indexterm>
				<primary>Master Boot Record</primary>
			</indexterm>


			<para>
				This problem is often caused by the installation of another operating system after you have installed &PRODUCT;. Some other operating systems assume that you have no other operating system(s) on your computer. They overwrite the Master Boot Record (MBR) that originally contained the GRUB2 boot loader. If the boot loader is overwritten in this manner, you cannot boot &PRODUCT; unless you can boot into installation program rescue mode and reconfigure the boot loader.
			</para>
			<para>
				Another common problem occurs when using a partitioning tool to resize a partition or create a new partition from free space after installation, and it changes the order of your partitions. If the partition number of your <filename class="directory">/</filename> partition changes, the boot loader might not be able to find it to mount the partition. To fix this problem, you will need to reinstall the boot loader. See <xref linkend="sect-rescue-reinstall-grub2" /> for instructions on how to do this.
			</para>
		</section>

		<section id="sect-rescue-mode-hardware-issues">
			<title>Hardware and Software Problems</title>


			<indexterm>
				<primary>system recovery</primary>
				<secondary>common problems</secondary>
				<tertiary>hardware and software problems</tertiary>
			</indexterm>


			<para>
				This category includes a wide variety of different situations. Two examples include failing hard drives and specifying an invalid root device or kernel in the boot loader configuration file. If either of these occur, you might not be able to reboot into &PRODUCT;. However, if you boot into installation program rescue mode, you might be able to resolve the problem or at least get copies of your most important files.
			</para>
		</section>

		<section id="sect-rescue-mode-reset-root-password">
			<title>Resetting the Root Password</title>
			<para>
				See the corresponding section in the <ulink url="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/sec-Terminal_Menu_Editing_During_Boot.html#sec-Changing_and_Resetting_the_Root_Password"><citetitle pubwork="book">Red&nbsp;Hat Enterprise&nbsp;Linux&nbsp;7 System Administrator's Guide</citetitle></ulink>.
			</para>
		</section>
	</section>

	<section id="sect-rescue-mode">
		<title>Anaconda Rescue Mode</title>


		<indexterm>
			<primary>installation program rescue mode</primary>
			<secondary>definition of</secondary>
		</indexterm>
		<indexterm>
			<primary>booting</primary>
			<secondary>rescue mode</secondary>
		</indexterm>
		<indexterm>
			<primary>installation program rescue mode</primary>
			<secondary>utilities available</secondary>
		</indexterm>
		<indexterm>
			<primary>rescue mode</primary>
			<secondary>using the installation program</secondary>
		</indexterm>


		<para>
			The <application>Anaconda</application> installation program's rescue mode is a minimal Linux environment that can be booted from the &PRODUCT; 7 DVD or other boot media. It contains command-line utilities for repairing a wide variety of issues. This rescue mode can be accessed from the <guisubmenu>Troubleshooting</guisubmenu> submenu of the boot menu. In this mode, you can mount file systems as read-only or even to not mount them at all, blacklist or add a driver provided on a driver disc, install or upgrade system packages, or manage partitions.
		</para>
		<note>
			<para>
				<application>Anaconda</application> rescue mode is different from <firstterm>rescue mode</firstterm> (an equivalent to <firstterm>single-user mode</firstterm>) and <firstterm>emergency mode</firstterm>, which are provided as parts of the <application>systemd</application> system and service manager. For more information about these modes, see <ulink url="https://access.redhat.com/site/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/index.html">Red&nbsp;Hat Enterprise&nbsp;Linux&nbsp;7 System Administrator's Guide</ulink>.
			</para>
		</note>
		<para>
			To boot into <application>Anaconda</application> rescue mode, you must be able to boot the system using one &PRODUCT; boot media, such as a minimal boot disc or USB drive, or a full installation DVD.
		</para>
		<para>
			For detailed information about booting the system using media provided by Red&nbsp;Hat, see the appropriate chapters:
		</para>
		<itemizedlist>
			<listitem>
				<para>
					<xref linkend="chap-booting-installer-x86" /> for AMD64 and Intel&nbsp;64 systems
				</para>
			</listitem>
			<listitem>
				<para>
					<xref linkend="chap-booting-installer-ppc" /> for IBM Power&nbsp;Systems servers
				</para>
			</listitem>
			<listitem>
				<para>
					<xref linkend="chap-installer-booting-ipl-s390" /> for IBM System&nbsp;z
				</para>
			</listitem>
		</itemizedlist>
		<important>
			<para>
				Advanced storage, such as iSCSI or zFCP devices, must be configured either using <systemitem>dracut</systemitem> boot options (such as <option>rd.zfcp=</option> or <option>root=iscsi:<replaceable>options</replaceable></option>), or in the CMS configuration file on IBM System&nbsp;z. It is not possible to configure these storage devices interactively after booting into rescue mode.
			</para>
			<para>
				For information about <systemitem>dracut</systemitem> boot options, see the <systemitem>dracut.cmdline(7)</systemitem> man page. For information about the CMS configuration file, see <xref linkend="chap-parameter-configuration-files-s390" />.
			</para>
		</important>
		<procedure id="proc-booting-into-installer-rescue-mode">
			<title>Booting into Anaconda Rescue Mode</title>
			<step>
				<para>
					Boot the system from either minimal boot media, or a full installation DVD or USB drive, and wait for the boot menu to appear.
				</para>
			</step>
			<step>
				<para>
					From the boot menu, either select the <guimenu>Rescue a &PRODUCT; system</guimenu> option from the <guisubmenu>Troubleshooting</guisubmenu> submenu, or append the <option>inst.rescue</option> option to the boot command line. To enter the boot command line, press the <keycap>Tab</keycap> key on BIOS-based systems or the <keycap>e</keycap> key on the UEFI-based systems.
				</para>
			</step>
			<step>
				<para>
					If your system requires a third-party driver provided on a <firstterm>driver disc</firstterm> to boot, append the <option>inst.dd=<replaceable>driver_name</replaceable></option> to the boot command line:
				</para>
<screen><command>inst.rescue inst.dd=<replaceable>driver_name</replaceable></command></screen>
				<para>
					For more information on using a driver disc at boot time, see <xref linkend="sect-driver-updates-manual-x86" /> for AMD64 and Intel&nbsp;64 systems or <xref linkend="sect-driver-updates-manual-ppc" /> for IBM Power&nbsp;Systems servers.
				</para>
			</step>
			<step>
				<para>
					If a driver that is part of the &PRODUCT;&nbsp;7 distribution prevents the system from booting, append the <option>modprobe.blacklist=</option> option to the boot command line:
				</para>
<screen><command>inst.rescue modprobe.blacklist=<replaceable>driver_name</replaceable></command></screen>
				<para>
					For more information about blacklisting drivers, see <xref linkend="sect-blacklisting-a-driver-x86" />.
				</para>
			</step>
			<step>
				<para>
					When ready, press <keycap>Enter</keycap> (BIOS-based systems) or <keycombo><keycap>Ctrl</keycap><keycap>X</keycap></keycombo> (UEFI-based systems) to boot the modified option. Then wait until the following message is displayed:
				</para>
<screen>
The rescue environment will now attempt to find your Linux installation and mount it under the <filename class="directory">/mnt/sysimage/</filename> directory. You can then make any changes required to your system. If you want to proceed with this step choose 'Continue'. You can also choose to mount your file systems read-only instead of read-write by choosing 'Read-only'. If for some reason this process fails you can choose 'Skip' and this step will be skipped and you will go directly to a command line.
</screen>
				<para>
					If you select <guibutton>Continue</guibutton>, it attempts to mount your file system under the directory <filename class="directory">/mnt/sysimage/</filename>. If it fails to mount a partition, you will be notified. If you select <guibutton>Read-Only</guibutton>, it attempts to mount your file system under the directory <filename class="directory">/mnt/sysimage/</filename>, but in read-only mode. If you select <guibutton>Skip</guibutton>, your file system is not mounted. Choose <guibutton>Skip</guibutton> if you think your file system is corrupted.
				</para>
			</step>
			<step>
				<para>
					Once you have your system in rescue mode, a prompt appears on VC (virtual console) 1 and VC 2 (use the <keycombo><keycap>Ctrl</keycap><keycap>Alt</keycap><keycap>F1</keycap></keycombo> key combination to access VC 1 and <keycombo><keycap>Ctrl</keycap><keycap>Alt</keycap><keycap>F2</keycap></keycombo> to access VC 2):
				</para>
<screen><prompt>sh-4.2#</prompt></screen>
			</step>
		</procedure>
		<para>
			Even if your file system is mounted, the default root partition while in <application>Anaconda</application> rescue mode is a temporary root partition, not the root partition of the file system used during normal user mode (<systemitem>multi-user.target</systemitem> or <systemitem>graphical.target</systemitem>). If you selected to mount your file system and it mounted successfully, you can change the root partition of the <application>Anaconda</application> rescue mode environment to the root partition of your file system by executing the following command:
		</para>
<screen><prompt>sh-4.2#</prompt> <command>chroot /mnt/sysimage</command></screen>
		<para>
			This is useful if you need to run commands, such as <command>rpm</command>, that require your root partition to be mounted as <filename class="directory">/</filename>. To exit the <command>chroot</command> environment, type <command>exit</command> to return to the prompt.
		</para>
		<para>
			If you selected <guibutton>Skip</guibutton>, you can still try to mount a partition or LVM2 logical volume manually inside <application>Anaconda</application> rescue mode by creating a directory, such as <filename class="directory"><replaceable>/directory/</replaceable></filename>, and typing the following command:
		</para>
<screen><prompt>sh-4.2#</prompt> <command>mount -t xfs <replaceable>/dev/mapper/VolGroup00-LogVol02</replaceable> <replaceable>/directory</replaceable></command></screen>
		<para>
			In the above command, <filename class="directory"><replaceable>/directory/</replaceable></filename> is a directory that you have created and <command><replaceable>/dev/mapper/VolGroup00-LogVol02</replaceable></command> is the LVM2 logical volume you want to mount. If the partition is a different type than XFS, replace the <replaceable>xfs</replaceable> string with the correct type (such as <literal>ext4</literal>).
		</para>
		<para>
			If you do not know the names of all physical partitions, use the following command to list them:
		</para>
<screen><prompt>sh-4.2#</prompt> <command>fdisk -l</command></screen>
		<para>
			If you do not know the names of all LVM2 physical volumes, volume groups, or logical volumes, use the <command>pvdisplay</command>, <command>vgdisplay</command> or <command>lvdisplay</command> commands, respectively.
		</para>
		<para>
			From the prompt, you can run many useful commands, such as:
		</para>
		<itemizedlist>
			<listitem>
				<para>
					<command>ssh</command>, <command>scp</command>, and <command>ping</command> if the network is started
				</para>
				<para>
					For details, see the <ulink url="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/s1-ssh-clients.html"><citetitle pubwork="book">Red&nbsp;Hat Enterprise&nbsp;Linux&nbsp;7 System Administrator's Guide</citetitle></ulink>.
				</para>
			</listitem>
			<listitem>
				<para>
					<command>dump</command> and <command>restore</command> for users with tape drives
				</para>
				<para>
					For details, see the <ulink url="https://access.redhat.com/labs/rbra/"><application>RHEL Backup and Restore Assistant</application></ulink>.
				</para>
			</listitem>
			<listitem>
				<para>
					<command>parted</command> and <command>fdisk</command> for managing partitions
				</para>
				<para>
					For details, see the <ulink url="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Storage_Administration_Guide/ch-partitions.html"><citetitle pubwork="book">Red&nbsp;Hat Enterprise&nbsp;Linux&nbsp;7 Storage Administration Guide</citetitle></ulink>.
				</para>
			</listitem>
			<listitem>
				<para>
					<command>rpm</command> for installing or upgrading software
				</para>
				<para>
					For details, see the <ulink url="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/ch-RPM.html"><citetitle pubwork="book">Red&nbsp;Hat Enterprise&nbsp;Linux&nbsp;7 Administrator's Guide</citetitle></ulink>
				</para>
			</listitem>
		</itemizedlist>
		<section id="sect-rescue-sosreport">
			<title>Capturing an <systemitem>sosreport</systemitem></title>


			<indexterm>
				<primary>system recovery</primary>
				<secondary>common problems</secondary>
				<tertiary>sosreport</tertiary>
			</indexterm>


			<para>
				The <systemitem>sosreport</systemitem> command-line utility collects configuration and diagnostic information, such as the running kernel version, loaded modules, and system and service configuration files, from the system. The utility output is stored in a tar archive in the <filename class="directory">/var/tmp/</filename> directory.
			</para>
			<para>
				The <systemitem>sosreport</systemitem> utility is useful for analyzing the system errors and can make troubleshooting easier. The following procedure describes how to capture an <systemitem>sosreport</systemitem> output in <application>Anaconda</application> rescue mode:
			</para>
			<procedure id="proc-rescue-sosreport">
				<title>Using <systemitem>sosreport</systemitem> in Anaconda Rescue Mode</title>
				<step>
					<para>
						Follow steps in <xref linkend="proc-booting-into-installer-rescue-mode" /> to boot into <application>Anaconda</application> rescue mode. Ensure that you mount the installed system <filename>/</filename> (root) partition in read-write mode.
					</para>
				</step>
				<step>
					<para>
						Change the root directory to the <filename class="directory">/mnt/sysimage/</filename> directory:
					</para>
<screen><prompt>sh-4.2#</prompt> <command>chroot /mnt/sysimage/</command></screen>
				</step>
				<step>
					<para>
						Execute <systemitem>sosreport</systemitem> to generate an archive with system configuration and diagnostic information:
					</para>
<screen><prompt>sh-4.2#</prompt> <command>sosreport</command></screen>
					<important>
						<para>
							When running, <systemitem>sosreport</systemitem> will prompt you to enter your name and case number that you get when you contact Red&nbsp;Hat Support service and open a new support case. Use only letters and numbers because adding any of the following characters or spaces could render the report unusable:
						</para>
<screen># % &amp; { } \ &lt; &gt; > * ? / $ ~ ' " : @ + ` | =</screen>
					</important>
				</step>
				<step>
					<para>
						<emphasis>Optional</emphasis>. If you want to transfer the generated archive to a new location using the network, it is necessary to have a network interface configured. In case you use the dynamic IP addressing, there are no other steps required. However, when using the static addressing, enter the following command to assign an IP address (for example <replaceable>10.13.153.64/23</replaceable>) to a network interface (for example <replaceable>dev eth0</replaceable>):
					</para>
<screen><prompt>bash-4.2#</prompt> <command>ip addr add <replaceable>10.13.153.64/23</replaceable> <replaceable>dev eth0</replaceable></command></screen>
					<para>
						See the <ulink url="https://access.redhat.com/site/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Networking_Guide/index.html">
						Red&nbsp;Hat Enterprise&nbsp;Linux&nbsp;7 Networking Guide</ulink> for additional information about static addressing.
					</para>
				</step>
				<step>
					<para>
						Exit the chroot environment:
					</para>
<screen><prompt>sh-4.2#</prompt> <command>exit</command></screen>
				</step>
				<step>
					<para>
						Store the generated archive in a new location, from where it can be easily accessible:
					</para>
<screen><prompt>sh-4.2#</prompt> <command>cp /mnt/sysimage/var/tmp/<replaceable>sosreport</replaceable> <replaceable>new_location</replaceable></command></screen>
					<para>
						For transferring the archive through the network, use the <systemitem>scp</systemitem> utility:
					</para>
<screen><prompt>sh-4.2#</prompt> <command>scp /mnt/sysimage/var/tmp/<replaceable>sosreport</replaceable> <replaceable>username@hostname:sosreport</replaceable></command></screen>
				</step>
			</procedure>
			<para>
				See the references below for further information:
			</para>
			<itemizedlist>
				<listitem>
					<para>
						For general information about <systemitem>sosreport</systemitem>, see <ulink url="https://access.redhat.com/site/solutions/3592">What is a sosreport and how to create one in Red&nbsp;Hat Enterprise&nbsp;Linux 4.6 and later?</ulink>.
					</para>
				</listitem>
				<listitem>
					<para>
						For information about using <systemitem>sosreport</systemitem> within <application>Anaconda</application> rescue mode, see <ulink url="https://access.redhat.com/site/solutions/2872">How to generate sosreport from the rescue environment</ulink>.
					</para>
				</listitem>
				<listitem>
					<para>
						For information about generating an <systemitem>sosreport</systemitem> to a different location than <filename class="directory">/tmp</filename>, see <ulink url="https://access.redhat.com/site/solutions/1847">How do I make sosreport write to an alternative location?</ulink>.
					</para>
				</listitem>
				<listitem>
					<para>
						For information about collecting an <systemitem>sosreport</systemitem> manually, see <ulink url="https://access.redhat.com/site/solutions/68996">Sosreport fails. What data should I provide in its place?</ulink>.
					</para>
				</listitem>
			</itemizedlist>
		</section>

		<section id="sect-rescue-reinstall-grub2">
			<title>Reinstalling the Boot Loader</title>


			<indexterm>
				<primary>system recovery</primary>
				<secondary>common problems</secondary>
				<tertiary>reinstalling the boot loader</tertiary>
			</indexterm>
			<indexterm>
				<primary>Master Boot Record</primary>
				<secondary>reinstalling</secondary>
			</indexterm>


			<para>
				In some cases, the GRUB2 boot loader can mistakenly be deleted, corrupted, or replaced by other operating systems. The following steps detail the process on how GRUB is reinstalled on the master boot record:
			</para>
			<procedure id="proc-rescue-reinstalling-GRUB2">
				<title>Reinstalling the GRUB2 Boot Loader</title>
				<step>
					<para>
						Follow instructions in <xref linkend="proc-booting-into-installer-rescue-mode" /> to boot into <application>Anaconda</application> rescue mode. Ensure that you mount the installed system's <filename>/</filename> (root) partition in read-write mode.
					</para>
				</step>
				<step>
					<para>
						Change the root partition:
					</para>
<screen><prompt>sh-4.2#</prompt> <command>chroot /mnt/sysimage/</command></screen>
				</step>
				<step>
					<para>
						Use the following command to reinstall the GRUB2 boot loader, where <replaceable>install_device</replaceable> is the boot device (typically, /dev/sda):
					</para>
<screen><prompt>sh-4.2#</prompt> <command>/sbin/grub2-install <replaceable>install_device</replaceable></command></screen>
				</step>
				<step>
					<para>
						Reboot the system.
					</para>
				</step>
			</procedure>
		</section>
		<section id="sect-rescue-driver-add-remove-replace">
			<title>Using RPM to Add, Remove, or Replace a Driver</title>
			<para>
				Missing or malfunctioning drivers can cause problems when booting the system. <application>Anaconda</application> rescue mode provides an environment in which you can add, remove, or replace a driver even when the system fails to boot. Wherever possible, we recommend that you use the <application>RPM</application> package manager to remove malfunctioning drivers or to add updated or missing drivers.
			</para>
			<note>
				<para>
					When you install a driver from a driver disc, the driver disc updates all initramfs images on the system to use this driver. If a problem with a driver prevents a system from booting, you cannot rely on booting the system from another initramfs image.
				</para>
			</note>
			<procedure id="proc-rescue-remove-drivers">
				<title>Using RPM to Remove a Driver</title>
				<step>
					<para>
						Boot the system into <application>Anaconda</application> rescue mode. Follow the instructions in <xref linkend="proc-booting-into-installer-rescue-mode" />. Ensure that you mount the installed system in read-write mode.
					</para>
				</step>
				<step>
					<para>
						Change the root directory to <filename class="directory">/mnt/sysimage/</filename>:
					</para>
<screen><prompt>sh-4.2#</prompt> <command>chroot /mnt/sysimage/</command></screen>
				</step>
				<step>
					<para>
						Use the <command>rpm -e</command> command to remove the driver package. For example, to remove the <package>xorg-x11-drv-wacom</package> driver package, run:
					</para>
<screen><prompt>sh-4.2#</prompt> <command>rpm -e <replaceable>xorg-x11-drv-wacom</replaceable></command></screen>
				</step>
				<step>
					<para>
						Exit the chroot environment:
					</para>
<screen><prompt>sh-4.2#</prompt> <command>exit</command></screen>
				</step>
			</procedure>
			<para>
				If you cannot remove a malfunctioning driver for some reason, you can instead <firstterm>blacklist</firstterm> the driver so that it does not load at boot time. See <xref linkend="sect-blacklisting-a-driver-x86" /> and <xref linkend="chap-anaconda-boot-options" /> for more information about blacklisting drivers.
			</para>
			<para>
				Installing a driver is a similar process but the RPM package must be available on the system:
			</para>
			<procedure id="proc-installing-a-driver-from-an-RPM-package">
				<title>Installing a Driver from an RPM package</title>
				<step>
					<para>
						Boot the system into <application>Anaconda</application> rescue mode. Follow the instructions in <xref linkend="proc-booting-into-installer-rescue-mode" />. Do <emphasis>not</emphasis> choose to mount the installed system as read only.
					</para>
				</step>
				<step>
					<para>
						Make the RPM package that contains the driver available. For example, mount a CD or USB flash drive and copy the RPM package to a location of your choice under <filename class="directory">/mnt/sysimage/</filename>, for example: <filename class="directory">/mnt/sysimage/root/drivers/</filename>
					</para>
				</step>
				<step>
					<para>
						Change the root directory to <filename class="directory">/mnt/sysimage/</filename>:
					</para>
<screen><prompt>sh-4.2#</prompt> <command>chroot /mnt/sysimage/</command></screen>
				</step>
				<step>
					<para>
						Use the <command>rpm -ivh</command> command to install the driver package. For example, to install the <package>xorg-x11-drv-wacom</package> driver package from <filename class="directory">/root/drivers/</filename>, run:
					</para>
<screen><prompt>sh-4.2#</prompt> <command>rpm -Â­ivh /root/drivers/xorg-x11-drv-wacom-0.23.0-6.el7.x86_64.rpm</command></screen>
					<note>
						<para>
							The <filename class="directory">/root/drivers/</filename> directory in this chroot environment is the <filename class="directory">/mnt/sysimage/root/drivers/</filename> directory in the original rescue environment.
						</para>
					</note>
				</step>
				<step>
					<para>
						Exit the chroot environment:
					</para>
<screen><prompt>sh-4.2#</prompt> <command>exit</command></screen>
				</step>
			</procedure>
			<para>
				When you have finished removing and installing drivers, reboot the system.
			</para>
		</section>
	</section>
</chapter>
